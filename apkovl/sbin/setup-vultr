#!/bin/sh -e

SERVICES="crond local ufw"

if [ $(id -u) -ne 0 ]; then
  echo "This script can only be run by root!" >&2
  exit 1
fi

echo "Installing required packages ..."
apk add \
  curl \
  doas-sudo-shim \
  docker-cli-compose@edge \
  docker-rootless-extras@edge \
  docs \
  ip6tables \
  keychain \
  mandoc \
  patch \
  ufw

rm -f /etc/profile.d/*.disabled

if type -P ufw > /dev/null; then
  echo
  echo "Configuring uncomplicated firewall ..."
  /sbin/setup-ufw
  ufw enable
fi

if type -P dockerd-rootless > /dev/null; then
  echo
  echo "Enabling cgroups v2 required by docker-rootless ..."
  sed -i -E 's/#(rc_cgroup_mode)=".*"/\1="unified"/' /etc/rc.conf
  SERVICES="${SERVICES} cgroups"
  /sbin/setup-subids
fi

if type -P tmux > /dev/null && [ ! grep -q tmux /etc/shells ]; then
  echo
  echo "Configuring additional login shells..."
  type -P tmux | tee -a /etc/shells
fi

echo
for service in ${SERVICES}; do
  if rc-service --exists $service; then
    rc-update add $service default
  fi
done
unset service

echo
echo "Running setup-alpine ..."
/sbin/setup-alpine -f "/root/$(basename ${0}).answers"
