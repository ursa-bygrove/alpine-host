#!/bin/sh -e

if [ $(id -u) -ne 0 ]; then
  echo "ERROR: This script can only be run by root!" >&2
  exit 1
fi

echo "Installing required packages ..."
apk update
apk add \
  curl \
  doas-sudo-shim \
  docker \
  docker-cli-compose \
  docs \
  drill \
  ip6tables \
  iptables \
  iproute2 \
  keychain \
  mandoc \
  patch \
  tmux

SERVICES="crond docker ip6tables iptables local"
export SSH_USER='dk'
export OTHER_USERS='live'

PS1_RED_USERS='live'
PS1_GRN_USERS="${SSH_USER}"

# Load setup-alpine answers file
. /root/setup-vultr.answers

# Disable root login
passwd -l root || :

# Configure RED users
sed -i \
  -E "s/([[:alnum:]|]+)) (PS1_USER_COLOR='red';;)/\1|${PS1_RED_USERS}) \2/" \
  /etc/profile.d/color_prompt.sh

# Configure GREEN users
sed -i \
  -E "s/([[:alnum:]|]+)) (PS1_USER_COLOR='green';;)/\1|${PS1_GRN_USERS}) \2/" \
  /etc/profile.d/color_prompt.sh

# Apply setup patches
echo
/root/apply-patches

# Include custom files when installing to disk
lbu add \
  /root/.exrc \
  /root/* \
  /usr/local

# Include patched files when installing to disk
for file in $(awk '$1=="+++" { print $2 }' /root/*.patch); do
  lbu add "${file}" "${file}."*
done

# Configure containerization service
if type -t docker > /dev/null; then
  echo
  echo 'Adding docker remap user ... dockremap'
  addgroup -S -g 500 dockremap
  adduser -SDH -u 500 -G dockremap dockremap

  echo
  echo 'Update docker daemon config ...'
  sed -i \
    -E "s/(\"userns-remap\"): \"default\"/\1 \"${SSH_USER}:docker\"/" \
    /etc/docker/daemon.json

  echo
  echo "Enabling cgroups v2 ..."
  sed -i -E 's/#(rc_cgroup_mode)=".*"/\1="unified"/' /etc/rc.conf
  SERVICES="${SERVICES} cgroups"
  /usr/local/sbin/setup-subids
fi

# Configure services started on boot
echo
echo "Starting local services ..."
for service in ${SERVICES}; do
  if rc-service --exists $service; then
    rc-update add $service default
  fi
done
unset service

echo
echo "Running setup-alpine ..."
/sbin/setup-alpine -e -f /root/setup-vultr.answers
